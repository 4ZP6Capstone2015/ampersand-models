CONTEXT PersonRegistration
-- The purpose of this file is to play around with KEY functionalities. To that end, we use a very common pattern that appear to suit most use-cases.
-----------------------------------------------------------
#define DoAccessControl 1
-----------------------------------------------------------
#include "SessionsAndAccounts.amp"
#include "AccountManagement.ifc"
-----------------------------------------------------------
PATTERN People

CONCEPT Person "someone of flesh and blood"

firstName       :: Person *  Text [UNI] -- everyone has a first name, but it may not be registered
lastName        :: Person -> Text       -- we assume that the last name is registered, for everyone
characteristics :: Person *  Text       -- as in the real world, we may use other characteristics to identify people

--KEY Persoon: Person(Name: firstName, TXT " ", lastName, TXT ", with characteristics: ", characteristics)
#define diamond(r,s)  ((-r ! s) /\ (r ! -s))
#define idr(r) diamond(r,r~)
RULE "KEY Persons": idr(firstName) /\ idr(lastName) /\ idr(characteristics) |- I[Person]
ENDPATTERN
-----------------------------------------------------------
PATTERN "Personal Accounts"

personalAccount :: Person * Account PRAGMA "" " may login using "

RULE "personal account integrity": personalAccount = personalAccount;(I /\ roles;'User';V)
MEANING "Every personal account must have been assigned the 'User' role and vice versa."
MESSAGE "Please make sure this account has the role 'User' assigned, since it is a personal account"

ENDPATTERN
-----------------------------------------------------------
PATTERN Searching
PURPOSE PATTERN Searching
{+For searching people, we need a simple facility. This pattern implements such a facility (using a singleton concept 'SearchQuery'
-- Om te zoeken: druk op Edit in de gewenste zoek interface (bv. "Zoek op naam"), 
-- voeg de zoekterm toe met Insert New, vul de term in en druk op Save.
-- NB. Na het zoeken moet de zoekterm weer verwijderd worden. 
-}

RULE "SearchQuery is a singleton": I[SearchQuery] = 'SearchQuery'
searchQuery :: SearchQuery * SearchQuery = [ ("SearchQuery", "SearchQuery") ]

searchForPerson :: SearchQuery * Person

ENDPATTERN
-----------------------------------------------------------
INTERFACE "Search a persoon" (searchForPerson) : I[SearchQuery]
BOX [ "Klantnr" : searchForPerson
      BOX [ "Voornaam"         : firstName
          , "Achternaam"       : lastName
          , "Karakteristieken" : characteristics
          ]
    ]
-----------------------------------------------------------
PROCESS HRM

ROLE HRMOfficer MAINTAINS "KEY Persons"

ENDPROCESS
-----------------------------------------------------------
#define userIsaHRMOfficer (I /\ V;'SESSION';sessionUser;userid~;roles;'HRMOfficer';V)
#if OblosysRoles==1
INTERFACE "Overview" FOR HRMOfficer: I[ONE]
#else
INTERFACE "Overview": I[ONE];userIsaHRMOfficer
#endif
BOX[ "People"   : V[ONE*Person]
   , "Accounts" : V[ONE*Account]
   , "Search"   : V[ONE*SearchQuery]
   ] 

#if OblosysRoles==1
INTERFACE "Person" (firstName,lastName,characteristics) FOR HRMOfficer: I[Person]
#else
INTERFACE "Person" (firstName,lastName,characteristics): I[Person];userIsaHRMOfficer
#endif
BOX[ "Person"         : I
   , "First name"     : firstName
   , "Last name"      : lastName
   , "Characteristics": characteristics
   , "Account"        : personalAccount
   ] 
-----------------------------------------------------------
--[By default, the administrator is logged in]-------------
POPULATION sessionUser[Session*Userid]  CONTAINS [ ("SESSION", "admin") ]
POPULATION sessionPassword[Session*Password] CONTAINS [ ("SESSION", "admin") ]

--[Account registry contents]------------------------------
POPULATION userid[Account*Userid]       CONTAINS [ ("Account_0", "admin") ]
POPULATION password[Account*Password]   CONTAINS [ ("Account_0", "admin") ]
POPULATION roles[Account*Role]          CONTAINS [ ("Account_0", "User") ]
POPULATION roles[Account*Role]          CONTAINS [ ("Account_0", "AccountAdmin") ]

POPULATION userid[Account*Userid]       CONTAINS [ ("Account_1", "pukp") ]
POPULATION password[Account*Password]   CONTAINS [ ("Account_1", "******") ]
POPULATION roles[Account*Role]          CONTAINS [ ("Account_1", "User") ]

POPULATION userid[Account*Userid]       CONTAINS [ ("Account_2", "klaassenj") ]
POPULATION password[Account*Password]   CONTAINS [ ("Account_2", "*******") ]
POPULATION emailaddr[Account*EmailAddr] CONTAINS [ ("Account_2", "j.klaassen@acme.com") ]
POPULATION roles[Account*Role]          CONTAINS [ ("Account_2", "User") ]

POPULATION userid[Account*Userid]       CONTAINS [ ("Account_3", "klaassenk") ]
POPULATION password[Account*Password]   CONTAINS [ ("Account_3", "*******") ]
POPULATION emailaddr[Account*EmailAddr] CONTAINS [ ("Account_3", "katrijn@acme.com") ]
POPULATION roles[Account*Role]          CONTAINS [ ("Account_3", "User") ]

POPULATION userid[Account*Userid]       CONTAINS [ ("Account_4", "apache01") ]
POPULATION password[Account*Password]   CONTAINS [ ("Account_4", "********") ]
POPULATION emailaddr[Account*EmailAddr] CONTAINS [ ("Account_4", "j.klaassen@acme.com") ]
POPULATION roles[Account*Role]          CONTAINS [ ("Account_4", "Webserver") ]

--[Person Registry Contents] ------------------------------
POPULATION firstName       CONTAINS [ ("P_001", "Rieks") ]
POPULATION lastName        CONTAINS [ ("P_001", "Joosten") ]
POPULATION characteristics CONTAINS [ ("P_001", "Over 18") ]
POPULATION characteristics CONTAINS [ ("P_001", "Lives in Groningen area") ]
POPULATION personalAccount CONTAINS [ ("P_001", "Account_0") ]
POPULATION roles           CONTAINS [ ("Account_0", "HRMOfficer") ]

POPULATION firstName       CONTAINS [ ("P_002", "Stef") ]
POPULATION lastName        CONTAINS [ ("P_002", "Joosten") ]

POPULATION lastName        CONTAINS [ ("P_003", "Joosten") ]
POPULATION characteristics CONTAINS [ ("P_003", "Over 18") ]
POPULATION characteristics CONTAINS [ ("P_003", "Lives in Peize area") ]

POPULATION firstName       CONTAINS [ ("P_004", "Martijn") ]
POPULATION lastName        CONTAINS [ ("P_004", "Schrage") ]
POPULATION characteristics CONTAINS [ ("P_004", "aka Oblosys") ]

POPULATION firstName       CONTAINS [ ("P_005", "Piet") ]
POPULATION lastName        CONTAINS [ ("P_005", "Puk") ]
POPULATION personalAccount CONTAINS [ ("P_005", "Account_1") ]
POPULATION roles           CONTAINS [ ("Account_1", "HRMOfficer") ]

POPULATION firstName       CONTAINS [ ("P_006", "Jan") ]
POPULATION lastName        CONTAINS [ ("P_006", "Klaassen") ]
POPULATION personalAccount CONTAINS [ ("P_006", "Account_2") ]

POPULATION firstName       CONTAINS [ ("P_007", "Katrijn") ]
POPULATION lastName        CONTAINS [ ("P_007", "Klaassen") ]
POPULATION personalAccount CONTAINS [ ("P_007", "Account_3") ]
-----------------------------------------------------------
ENDCONTEXT
